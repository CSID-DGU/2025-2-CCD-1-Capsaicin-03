name: AI Server CI/CD

on:
  push:
    branches: 
      - "main"
    paths:
      - "AI/**"
      - ".github/workflows/deploy-ai.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3ï¸âƒ£ AI Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/na-murok-ai
          TAG=dev
          docker build -t $IMAGE_NAME:$TAG ./AI

      # 4ï¸âƒ£ Docker Hubë¡œ í‘¸ì‹œ
      - name: Push Docker image
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/na-murok-ai
          TAG=dev
          docker push $IMAGE_NAME:$TAG

      # 5ï¸âƒ£ EC2ë¡œ ë°°í¬
      - name: Deploy to EC2 (DEV)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/na-murok-ai
            TAG=dev
            CONTAINER_NAME=ai-server-dev
            PORT=8000

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true

            # ENV íŒŒì¼ ìƒì„± (.env)
            echo "${{ secrets.AI_ENV_DEV }}" > ai.env

            # ìµœì‹  ì´ë¯¸ì§€ pull
            sudo docker pull $IMAGE_NAME:$TAG

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (8000 í¬íŠ¸ë¡œ ì™¸ë¶€ ê³µê°œ)
            sudo docker run -d \
              -p $PORT:8000 \
              --env-file ai.env \
              --name $CONTAINER_NAME \
              $IMAGE_NAME:$TAG

            rm ai.env

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            sudo docker image prune -f

            echo "ğŸš€ AI Server ë°°í¬ ì™„ë£Œ! ì»¨í…Œì´ë„ˆ: $CONTAINER_NAME"
